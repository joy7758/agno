name: Update API Reference Docs

on:
  release:
    types: [published]
  workflow_dispatch: # Allow manual trigger for testing

permissions:
  contents: read

jobs:
  update-api-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout agno repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e libs/agno
          pip install a2a-sdk ag-ui-protocol slack-sdk

      - name: Generate OpenAPI schema
        run: |
          python scripts/generate_openapi.py /tmp/openapi.json

      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          repository: agno-agi/agno-docs
          token: ${{ secrets.DOCS_REPO_TOKEN }}
          path: docs-repo

      - name: Check for changes
        id: diff
        run: |
          if diff -q docs-repo/reference-api/openapi.json /tmp/openapi.json > /dev/null 2>&1; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No API changes detected."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "API changes detected."
          fi

      - name: Update OpenAPI spec
        if: steps.diff.outputs.changed == 'true'
        run: |
          cp /tmp/openapi.json docs-repo/reference-api/openapi.json

      - name: Regenerate schema pages
        if: steps.diff.outputs.changed == 'true'
        run: |
          rm -rf docs-repo/reference-api/schema/*
          npx @mintlify/scraping@latest openapi-file docs-repo/reference-api/openapi.json -o docs-repo/reference-api/schema

      - name: Update docs.json navigation
        if: steps.diff.outputs.changed == 'true'
        run: |
          python scripts/update_docs_navigation.py docs-repo

      - name: Create Pull Request
        if: steps.diff.outputs.changed == 'true'
        id: create-pr
        run: |
          cd docs-repo
          RELEASE_TAG="${{ github.event.release.tag_name || 'manual' }}"
          BRANCH="auto/api-reference-${RELEASE_TAG}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "Update API reference for ${RELEASE_TAG}"
          git push origin "$BRANCH"

          PR_URL=$(gh pr create \
            --repo agno-agi/agno-docs \
            --title "Update API reference for ${RELEASE_TAG}" \
            --body "$(cat <<EOF
          ## Summary

          Automated update of the AgentOS API reference for release \`${RELEASE_TAG}\`.

          - Regenerated \`openapi.json\` from the latest agno source
          - Rebuilt schema pages via mintlify scraping
          - Updated \`docs.json\` navigation for any new/removed endpoints

          > Generated by the [update-api-docs](https://github.com/agno-agi/agno/actions/workflows/update-api-docs.yml) workflow.
          EOF
          )" \
            --base main \
            --head "$BRANCH")

          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.DOCS_REPO_TOKEN }}

      - name: Notify Slack (changes)
        if: steps.diff.outputs.changed == 'true'
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets.SLACK_DOCS_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "API Reference updated for release `${{ github.event.release.tag_name || 'manual' }}`\nPR: ${{ steps.create-pr.outputs.pr_url }}"
            }

      - name: Notify Slack (no changes)
        if: steps.diff.outputs.changed == 'false'
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets.SLACK_DOCS_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "Release `${{ github.event.release.tag_name || 'manual' }}` - no API changes detected. Docs are up to date."
            }
